{% extends 'base.html' %}
{% load static %}

{% block title %}
<title>Movies | Home</title>
{% endblock %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<!-- <div id="cityPopup" style="display:none;">
    <p>Please select your city:</p>
    <button class="cityOption" value="Bangalore">Bangalore</button>
    <button class="cityOption" value="Hyderabad">Hyderabad</button>
    <button class="cityOption" value="Mumbai">Mumbai</button>
    <button class="cityOption" value="Delhi">Delhi</button>
    <button class="cityOption" value="chennai">chennai</button>

</div> -->
<div class="container">
    <div class="row mb-5">
        <div class="col-12">
            <div class="row">
                <div class="col-10 offset-2 m-5">
                    <h1>Now Showcasing</h1>
                    <div id="movies_now">
                        Please select the location
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
var displayedFilmIds = [];

$('#cityDropdown').change(function(e){
    displayedFilmIds = [];
    var currentDateTime = new Date().toISOString();     
    var selectedOption = $('#cityDropdown').find('option:selected');
    var loc = selectedOption.attr('class');
    console.log(loc);
    $.ajax({
    url: "https://api-gate2.movieglu.com/cinemasNearby/?n=5", 
    method: "GET",
    headers: {
        "client": "STUD_324",   
        "x-api-key": "4CceFE4yrv6iQJeBIMJfn6e6LMMHkxFV5BVDEqB1",
        "authorization": "Basic U1RVRF8zMjQ6a1pzVjNQV25sSnhu", 
        "territory": "US",
        "api-version": "v200",
        "geolocation": loc,
        "device-datetime": currentDateTime,
        },
    success: function(response) {
        const cinemaIds = response.cinemas.map(cinema => cinema.cinema_id);
        // For each cinema ID, fetch showtimes
        $('#movies_now').empty();
        cinemaIds.forEach(cinemaId => {
            const currentDate = new Date().toISOString().split('T')[0]; // Format as 'YYYY-MM-DD'
            console.log(cinemaId);
            fetchCinemaShowtimes(cinemaId, currentDate,loc);
            // console.log(cinemaId);
        });
        
    },
    error: function(error) {
        console.log("Error:", error);
    }
    });

});
function fetchCinemaShowtimes(cinemaId, date,loc) {
    var selectedOption = $('#cityDropdown').find('option:selected');
    var currentDateTime = new Date().toISOString();
    var loc = selectedOption.attr('class');
    const options = {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        timeZone: 'America/New_York',
    };
    const _Date = new Date().toLocaleDateString('en-US', options);
    const [month, day, year] = _Date.split('/');
    month1 =month.padStart(2,'0');

    var date= `${year}-${month1}-${day}`;
    console.log(`url:https://api-gate2.movieglu.com/cinemaShowTimes/?cinema_id=${cinemaId}&date=${date}&sort=popularity`);
    $.ajax({
        url: `https://api-gate2.movieglu.com/cinemaShowTimes/?cinema_id=${cinemaId}&date=${date}&sort=popularity`, 
        method: "GET",
        headers: {
            "client": "STUD_324",   
        "x-api-key": "4CceFE4yrv6iQJeBIMJfn6e6LMMHkxFV5BVDEqB1",
        "authorization": "Basic U1RVRF8zMjQ6a1pzVjNQV25sSnhu",
        "territory": "US",
        "api-version": "v200",
        "device-datetime": currentDateTime,
        },
        success: function(showtimesResponse) {
            console.log(showtimesResponse);
            if(showtimesResponse){
              const filmsData = showtimesResponse.films.map(film => ({
              film_id: film.film_id,
              film_image: film.images.poster["1"] ? film.images.poster["1"].medium.film_image : 'No image available'
            }));
            console.log(`Film data for cinema ID ${cinemaId}:`, filmsData);
            filmsData.forEach(film => {
                if (!displayedFilmIds.includes(film.film_id)) {
                $('#movies_now').append(`
                    <div class="card">
                        <img src="${film.film_image}" alt="Film Image" data-film-id="${film.film_id}" onclick="handleImageClick(${film.film_id})">
                    </div>
                `);
                displayedFilmIds.push(film.film_id);}
            });
            }
        },
        error: function(error) {
            console.log("Error fetching showtimes for cinema ID " + cinemaId + ":", error);
        }
    });
}
function handleImageClick(filmId) {
    var currentDateTime = new Date().toISOString();
    var selectedOption = $('#cityDropdown').find('option:selected');
    var loc = selectedOption.attr('class');
    console.log(loc);

    $.ajax({
        url: `https://api-gate2.movieglu.com/closestShowing/?film_id=${filmId}&n=10`, 
        method: 'GET',
        headers:{
            "client": "STUD_324",   
        "x-api-key": "4CceFE4yrv6iQJeBIMJfn6e6LMMHkxFV5BVDEqB1",
        "authorization": "Basic U1RVRF8zMjQ6a1pzVjNQV25sSnhu",
        "territory": "US",
        "api-version": "v200",
        "geolocation": loc,
        "device-datetime": currentDateTime,
        },
        success: function(data) {
            $.ajax({
                url: '/post_cinemas_for_film',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data), // Assuming 'response' is your JSON data
                success: function(response) {
                    if(response.success && response.redirect_url) {
                        window.location.href = response.redirect_url; // Redirect the browser to the new URL
                            }
                },
                error: function(xhr, status, error) {
                    console.log('error in ajax')
                }
});
        },
        error: function(error) {
            // Handle error
            console.error(error);
        }
    });
}

</script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<script src="{% static 'js/index.js' %}">
</script>

{% endblock %}
