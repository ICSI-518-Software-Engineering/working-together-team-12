
 {% extends 'base.html' %} 
{% load crispy_forms_tags %}

{% block content %}
<div class="profile-main">
    <div class="profile-container">
        <h2>Edit Profile</h2>
    
    <form id="profileForm" method="POST" enctype="multipart/form-data" class="profile-form">
        <div class="form-group">
            <label for="profileImage">Profile Image:</label>
            {% if user_profile.profile_pic %}
                <img src="{{ user_profile.profile_pic.url }}" alt="Current Profile Pic" height="100">
            {% endif %}
            <input type="file" id="profileImage" name="profileImage">
        </div>
        <input type="text" style="display: none;"   id="form-type" name="type" value="profileForm">
    
        <div class="form-group">
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" name="firstName" required value="{{ user_profile.name|default_if_none:'' }}">
        </div>
        <div class="form-group">
            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" name="lastName" required value="{{ user_profile.lname|default_if_none:'' }}">
        </div>
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required value="{{ user_profile.email|default_if_none:'' }}">
        </div>
        <div class="form-group" id="addressGroup">
            <label>Address:</label>
            <input type="text" id="flatDetails" name="flatDetails" placeholder="Flat No" required value="{{ user_profile.address|default_if_none:'' }}">
            <input type="text" id="line1" name="line1" placeholder="Line 1" value="{{ user_profile.line1|default_if_none:'' }}">
            <input type="text" id="line2" name="line2" placeholder="Line 2" value="{{ user_profile.line2|default_if_none:'' }}">
            <div class="form-row">
                <div class="form-group half-width">
                    <input type="text" id="state" name="state" placeholder="State" required value="{{ user_profile.state|default_if_none:'' }}">
                </div>
                <div class="form-group half-width">
                    <input type="text" id="country" name="country" placeholder="Country" required value="{{ user_profile.country|default_if_none:'' }}">
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>Phone:</label>
            <div class="phno_content">
                <div class="countryCode">
                    <select id="countryCode" name="countryCode" required>
                        <option value="1" {% if user_profile.country_code == 1 %}selected{% endif %}>+1</option>
                        <option value="91" {% if user_profile.country_code == 91 %}selected{% endif %}>+91</option>
                    </select>
                </div>
                <div class="phno">
                    <input type="text" id="phno" name="phno" required value="{{ user_profile.phno|default_if_none:'' }}">
                </div>
            </div>
        </div>
        <button type="button" id="updateProfileBtn" class="update-btn">Update Profile</button>
    </form>
    
    
        <h3>Add Payment Detail</h3>
        <form id="paymentForm" method="POST" class="payment-form">
            <div class="form-group">
                <label for="cardNumber">Card Number:</label>
                <input type="text" id="card_number" name="cardNumber" value="{{ payment_details.card_number|default:'' }}" required>
            </div>
        <input type="text" style="display: none;" id="form-type1" name="type" value="paymentForm">
    
            <div class="form-group">
                <label for="cvv">CVV:</label>
                <input type="password" id="cvv" name="cvv" value="{{ payment_details.cvv|default:'' }}" required>
            </div>
            <div class="form-group">
                <label for="cardHolderName">Card Holder Name:</label>
                <input type="text" id="card_holder_name" name="cardHolderName" value="{{ payment_details.card_holder_name|default:'' }}" required>
            </div>
            <div class="form-group">
                <label for="expiryMonth">Expiry Month:</label>
                <select id="expiry_month" name="expiryMonth" required>
                    <option value="1">1</option>
                    <script>
                        const selectedMonth = "{{ payment_details.expiry_month|default_if_none:'' }}"; 
                        
                        for (let i = 2; i <= 12; i++) {
                            // Check if current iteration matches the selectedMonth
                            const isSelected = i.toString() === selectedMonth;
                            document.write(`<option value="${i}" ${isSelected ? 'selected' : ''}>${i}</option>`);
                        }
                    </script>
                </select>
            </div>
            <div class="form-group">
                <label for="expiryYear">Expiry Year:</label>
                <select id="expiry_year" name="expiryYear" required>
                    <option value="2024">2024</option>
                    <script>
                        const selectedYear = "{{ payment_details.expiry_year|default_if_none:'' }}"; 
                        
                        const currentYear = 2024;
                        for (let i = currentYear+1; i <= currentYear + 20; i++) {
                            const isSelected = i.toString() === selectedYear;
                            document.write(`<option value="${i}" ${isSelected ? 'selected' : ''}>${i}</option>`);
                        }
                    </script>
                </select>
            </div>
            <button type="button" id="addPaymentBtn" class="add-payment-btn">Add Payment</button>
        </form>
        
    
        <div class="payment-details-card">
            <h3 class="payment-details-header">Payment Details</h3>
            <ul class="payment-details-list">
                {% for payment_detail in user.userprofile.payment_details.all %}
                <li class="payment-detail-item">
                    <strong>Card Holder Name:</strong> {{ payment_detail.card_holder_name }}
                    <strong>Card Number:</strong> **** **** **** {{ payment_detail.card_number|slice:"-4:" }}
                    <strong>Expiry Date:</strong> {{ payment_detail.expiry_date|date:"m/Y" }}
                </li>
                {% empty %}
                <li class="no-payment">No payment details added.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>


<style>
    .profile-main{
        background-image: url("/static/profile_bg.jpg");
        max-height: 600px;
        overflow-y: auto;
    }
    .form-row {
        display: flex;
        justify-content: space-between;
        gap: 20px;
    }
    .phno_content{
        display: flex;
        flex-direction: row;
        margin-bottom: 10px;
    }
    #countryCode,#phno{
        height: 40px;
    }

    /* Half-width form fields for side-by-side layout */
    .half-width {
        flex: 1;
    }
    .payment-details-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    .payment-details-list li {
        background-color: #f7f7f7;
        border: 1px solid #ddd;
        margin-top: 10px;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .payment-details-list li:first-child {
        margin-top: 0;
    }
    .payment-detail {
        font-size: 16px;
        color: #333;
    }
    .payment-detail strong {
        font-weight: 600;
    }
    .payment-details-header {
        text-align: center;
        margin-bottom: 20px;
    }
    .card-number {
        letter-spacing: 2px;
    }
    .expiry-date {
        color: #555;
    }
    .no-payment {
        text-align: center;
        padding: 20px;
        background-color: #fafafa;
    }
     .payment-form .form-section {
        margin-bottom: 20px;
    }
    .payment-form label, .payment-details-list label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .payment-form input, .payment-form select {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    .add-payment-btn {
        background-color: #4CAF50;
        color: white;
        /* padding: 10px 15px; */
        border: none;
        max-height: 50px;
        margin-top: 25px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    .add-payment-btn:hover {
        background-color: #45a049;
    }
    .payment-details-list {
        list-style-type: none;
        padding: 0;
    }
    .payment-details-list li {
        margin-bottom: 10px;
        background-color: #f2f2f2;
        padding: 10px;
        border-radius: 5px;
    }
    .payment-form {
        margin-top: 20px;
        background-color: #f4f4f4;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .payment-form .form-section {
        margin-bottom: 20px;
    }
    .payment-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .payment-form input[type="text"],
    .payment-form input[type="date"],
    .payment-form input[type="number"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    .add-payment-btn {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    .add-payment-btn:hover {
        background-color: #0056b3;
    }

    .payment-details-list {
        list-style-type: none;
        padding-left: 0;
        margin-top: 20px;
    }
    .payment-details-list li {
        background-color: #fff;
        margin-bottom: 10px;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
     .payment-details-list {
        list-style-type: none;
        padding: 0;
    }
    .payment-details-list li {
        margin-bottom: 10px;
        background-color: #f2f2f2;
        padding: 10px;
        border-radius: 5px;
    }
    .profile-container {
        max-width: 800px;
        margin: auto;
        padding: 20px;
        border-radius: 8px;
        background-color: #f9f9f9;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .profile-form h3 {
        color: #333;
        margin-bottom: 10px;
    }
    .profile-form .form-section {
        margin-bottom: 20px;
    }
    .profile-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .profile-form input[type="text"],
    .profile-form input[type="email"],
    .profile-form input[type="password"],
    .profile-form textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box; /* Adds padding without increasing the width of the input */
    }
    .profile-form input[type="file"] {
        border: none;
    }
    .update-btn {
        background-color: #4CAF50;
        color: white;
        padding: 15px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    .update-btn:hover {
        background-color: #45a049;
    }
    .form-row {
    display: flex;
    justify-content: space-between;
}

.form-group {
    margin-right: 20px;
}

.card-expiry {
    display: flex;
    justify-content: start;
}

.card-expiry label {
    margin-right: 10px;
}

.payment-form {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
}

.payment-form .form-group {
    flex-basis: calc(50% - 20px); /* Adjust based on form size */
}

/* Adjustments for small screens */
@media (max-width: 768px) {
    .form-row {
        flex-direction: column;
    }

    .form-group {
        margin-right: 0;
        margin-bottom: 15px;
    }

    .card-expiry {
        flex-direction: column;
    }

    .card-expiry label {
        margin-right: 0;
    }

    .payment-form .form-group {
        flex-basis: 100%; /* Full width on small screens */
    }
}

</style>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        function clearPreviousErrors() {
            document.querySelectorAll('.error-message').forEach(function(message) {
                message.remove();
            });
        }
    
        function showError(inputElement, message) {
            const error = document.createElement('div');
            error.textContent = message;
            error.className = 'error-message';
            error.style.color = 'red';
            error.style.fontSize = '0.8em';
            inputElement.parentNode.insertBefore(error, inputElement.nextSibling);
        }
    
        function validateProfileForm() {
            clearPreviousErrors();
            let isValid = true;
            const firstName = document.getElementById('firstName');
            const lastName = document.getElementById('lastName');
            const email = document.getElementById('email');
            const flatDetails = document.getElementById('flatDetails');
            const state = document.getElementById('state');
            const country = document.getElementById('country');
            const phno = document.getElementById('phno');
            const phnoRegex = /^\+?1?\d{9,15}$/;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
            if (!firstName.value.trim()) {
                showError(firstName, 'First name is required.');
                isValid = false;
            }
            if (!lastName.value.trim()) {
                showError(lastName, 'Last name is required.');
                isValid = false;
            }
            if (!email.value.match(emailRegex)) {
                showError(email, 'Please enter a valid  email address');
                isValid = false;
            }
            if (!flatDetails.value.trim()) {
                showError(flatDetails, 'Flat details are required.');
                isValid = false;
            }
            if (!state.value.trim()) {
                showError(state, 'State is required.');
                isValid = false;
            }
            if (!country.value.trim()) {
                showError(country, 'Country is required.');
                isValid = false;
            }
            if (!phno.value.match(phnoRegex)) {
                showError(phno, 'Please enter a valid phone number.');
                isValid = false;
            }
    
            return isValid;
        }
    
        function validatePaymentForm() {
            clearPreviousErrors();
            let isValid = true;
            const cardNumber = document.getElementById('card_number');
            const cvv = document.getElementById('cvv');
            if (cardNumber.value.length !== 16) {
                showError(cardNumber, 'Card number must be 16 digits.');
                isValid = false;
            }
            if (cvv.value.length !== 3) {
                showError(cvv, 'CVV must be 3 digits.');
                isValid = false;
            }
    
            return isValid;
        }
    
       
        document.getElementById('updateProfileBtn').addEventListener('click', function(e) {
            e.preventDefault();
        if (validateProfileForm()) {
        var formData = new FormData();
        
        formData.append('firstName', document.getElementById('firstName').value);
        formData.append('lastName', document.getElementById('lastName').value);
        formData.append('email', document.getElementById('email').value);
        formData.append('flatDetails', document.getElementById('flatDetails').value);
        formData.append('line1', document.getElementById('line1').value);
        formData.append('line2', document.getElementById('line2').value);
        formData.append('state', document.getElementById('state').value);
        formData.append('country', document.getElementById('country').value);
        formData.append('countryCode', document.getElementById('countryCode').value);
        formData.append('phno', document.getElementById('phno').value);
        formData.append('type',document.getElementById('form-type').value);
        
        
        var profileImage = document.getElementById('profileImage').files[0];
        if (profileImage) {
            formData.append('profileImage', profileImage);
        }

        fetch('/profile/', { 
            method: 'POST',
            body: formData,
     
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (!data.success){
                alert(data.error);
            }
            if (data.redirect_url){
            window.location.href = data.redirect_url;}
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the profile.');
        });
    
    }
        });

    
        document.getElementById('addPaymentBtn').addEventListener('click', function(e) {
            e.preventDefault();
            if (validatePaymentForm()) {
                var formData = new FormData();
        
            formData.append('card_number', document.getElementById('card_number').value);
            formData.append('cvv', document.getElementById('cvv').value);
            formData.append('card_holder_name', document.getElementById('card_holder_name').value);
            formData.append('expiry_year', document.getElementById('expiry_year').value);
            formData.append('expiry_month', document.getElementById('expiry_month').value);
            formData.append('type',document.getElementById('form-type1').value);
        

            fetch('/profile/', { 
                method: 'POST',
                body: formData,
        
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (!data.success){
                    alert(data.error);
                }
                if (data.redirect_url){
                window.location.href = data.redirect_url;}
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the profile.');
            });

        }
        });
    });
    </script>
    
    
{% endblock %}
